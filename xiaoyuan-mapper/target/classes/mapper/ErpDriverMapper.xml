<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.xiaoyuan.mapper.ErpDriverMapper">
    <update id="updateByUserid">
        update tl_erp_driver
        <set>
            <if test="driver_sn != null and driver_sn != ''">
                driver_sn=#{driver_sn},
            </if>
            <if test="car_sn != null and car_sn != ''">
                car_sn=#{car_sn},
            </if>
            <if test="driver_use_date != null and driver_use_date != ''">
                driver_use_date=#{driver_use_date},
            </if>
            <if test="updatetime != null and updatetime != ''">
                updatetime= #{updatetime},
            </if>
            <if test="driver_eff_date != null and driver_eff_date != ''">
                driver_eff_date=#{driver_eff_date}
            </if>
        </set>
        where user_id = #{user_id}
    </update>



    <update id="updateServiceByPrimaryKey">
        update tl_erp_driver
        <set>
            <trim suffixOverrides=",">
                <if test="user_id != null">
                    user_id=#{user_id},
                </if>
                <if test="car_sn != null">
                    car_sn=#{car_sn},
                </if>
                <if test="driver_sn != null">
                    driver_sn=#{driver_sn},
                </if>
                <if test="driver_use_date != null">
                    driver_use_date=#{driver_use_date},
                </if>
                <if test="driver_eff_date != null">
                    driver_eff_date=#{driver_eff_date},
                </if>
                <if test="car_cate != null">
                    car_cate=#{car_cate},
                </if>
                <if test="createtime != null">
                    createtime=#{createtime},
                </if>
                <if test="updatetime != null">
                    updatetime= #{updatetime},
                </if>
                <if test="status_ != null">
                    status_= #{status_},
                </if>
                <if test="driver_delivery_sn != null">
                    driver_delivery_sn= #{driver_delivery_sn},
                </if>
                <if test="car_id != null">
                    car_id= #{car_id},
                </if>
                <if test="goods_id != null">
                    goods_id= #{goods_id},
                </if>
                <if test="goods_name != null">
                    goods_name= #{goods_name},
                </if>
                <if test="cate_id != null">
                    cate_id= #{cate_id},
                </if>
                <if test="is_inside != null">
                    is_inside= #{is_inside},
                </if>
            </trim>
        </set>
        where user_id = #{user_id}
    </update>


    <insert id="insert" useGeneratedKeys="true" keyProperty="id"
            parameterType="com.xiaoyuan.model.ErpDriver">
		insert into tl_erp_driver
		(id,user_id,car_sn,driver_sn,driver_eff_date,driver_use_date,car_cate,createtime,updatetime,status_,driver_delivery_sn)
		values
		(#{id},#{user_id},#{car_sn},#{driver_sn},#{driver_eff_date},#{driver_use_date},#{car_cate},#{createtime},#{updatetime},#{status_},#{driver_delivery_sn})
	</insert>
    <insert id="insertService">
        insert into
        tl_erp_driver
        <trim prefix="(" suffixOverrides="," suffix=")">
            <if test="user_id != null">
                user_id,
            </if>
            <if test="car_sn != null">
                car_sn,
            </if>
            <if test="driver_sn != null">
                driver_sn,
            </if>
            <if test="driver_use_date != null">
                driver_use_date,
            </if>
            <if test="driver_eff_date != null">
                driver_eff_date,
            </if>
            <if test="car_cate != null">
                car_cate,
            </if>
            <if test="createtime != null">
                createtime,
            </if>
            <if test="updatetime != null">
                updatetime,
            </if>
            <if test="status_ != null">
                status_,
            </if>
            <if test="driver_delivery_sn != null">
                driver_delivery_sn,
            </if>
            <if test="car_id != null">
                car_id,
            </if>
            <if test="goods_id != null">
                goods_id,
            </if>
            <if test="goods_name != null">
                goods_name,
            </if>
            <if test="cate_id != null">
                cate_id,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="user_id != null">
               #{user_id},
            </if>
            <if test="car_sn != null">
                #{car_sn},
            </if>
            <if test="driver_sn != null">
               #{driver_sn},
            </if>
            <if test="driver_use_date != null">
                #{driver_use_date},
            </if>
            <if test="driver_eff_date != null">
                #{driver_eff_date},
            </if>
            <if test="car_cate != null">
                #{car_cate},
            </if>
            <if test="createtime != null">
                #{createtime},
            </if>
            <if test="updatetime != null">
                #{updatetime},
            </if>
            <if test="status_ != null">
                #{status_},
            </if>
            <if test="driver_delivery_sn != null">
                #{driver_delivery_sn},
            </if>
            <if test="car_id != null">
                #{car_id},
            </if>
            <if test="goods_id != null">
                #{goods_id},
            </if>
            <if test="goods_name != null">
                #{goods_name},
            </if>
            <if test="cate_id != null">
                #{cate_id},
            </if>
        </trim>

    </insert>

    <select id="getDriverByUserId" resultType="com.xiaoyuan.model.ErpDriver">
		SELECT
		*
		FROM
		tl_erp_driver
		WHERE user_id = #{user_id}
	</select>

    <!--SELECT
        u.user_company_name,
        u.user_wechat AS user_wechar,
        dr.car_cate,
        r.id,
        dr.user_id,
        dr.car_sn,
        r.`car_owner` AS car_owner,
        car_contact_phone,
        u.user_name AS user_name,
        u.user_phone AS user_phone,
        d.card_rfid,
        car_weight,
        car_length,
        car_load,
        s.gps_sn AS gps_sn,
        s.gps_imei AS gps_imei,
        dr.driver_sn,
        dr.driver_use_date,
        dr.driver_eff_date
    FROM
        tl_erp_user u
        INNER JOIN tl_erp_driver dr ON u.id = dr.`user_id`
        LEFT JOIN tl_erp_card d ON d.`driver_id` = dr.id
        LEFT JOIN tl_erp_gps s ON s.driver_id = dr.id
        INNER JOIN tl_erp_car r ON r.`driver_id` = dr.id
            AND u.id = #{id}-->
    <select id="getDriverById" resultType="com.xiaoyuan.model.ErpDriver">
        SELECT
            u.number,
            u.real_name,
            u.user_company_name,
            u.user_wechat AS user_wechar,
            dr.car_cate,
            r.id,
            dr.user_id,
            dr.car_sn,
            r.`car_owner` AS car_owner,
            car_contact_phone,
            u.user_name AS user_name,
            u.user_phone AS user_phone,
            d.card_rfid,
            car_weight,
            car_length,
            car_load,
            s.gps_sn AS gps_sn,
            s.gps_imei AS gps_imei,
            dr.driver_sn,
            dr.driver_use_date,
            dr.driver_eff_date,
            dr.status_
        FROM
            tl_erp_user u
            LEFT JOIN tl_erp_driver dr ON u.id = dr.`user_id`
            LEFT JOIN tl_erp_card d ON d.`driver_id` = dr.id
            LEFT JOIN tl_erp_gps s ON s.driver_id = dr.id
            LEFT JOIN tl_erp_car r ON r.`driver_id` = dr.id
            where dr.id=#{id} and u.stop is null
    </select>
    <select id="get" resultType="com.xiaoyuan.model.ErpDriver">
SELECT
u.number,
u.real_name,
	u.user_company_name,
	u.user_wechat AS user_wechar,
	dr.car_cate,
	r.id,
	dr.user_id,
	dr.car_sn,
	r.`car_owner` AS car_owner,
	car_contact_phone,
	u.user_name AS user_name,
	u.user_phone AS user_phone,
	d.card_rfid,
	car_weight,
	car_length,
	car_load,
	s.gps_sn AS gps_sn,
	s.gps_imei AS gps_imei,
	dr.driver_sn,
	dr.driver_use_date,
	dr.driver_eff_date
FROM
	tl_erp_user u
	LEFT JOIN tl_erp_driver dr ON u.id = dr.`user_id`
	LEFT JOIN tl_erp_card d ON d.`driver_id` = dr.id
	LEFT JOIN tl_erp_gps s ON s.driver_id = dr.id
	LEFT JOIN tl_erp_car r ON r.`driver_id` = dr.id
	where u.id=#{id}
	</select>

    <!-- YZH 20190304 debug 84 加一个id传参，作修改车牌去重用，!=null好像也行，， -->
    <select id="carsn" resultType="com.xiaoyuan.model.ErpDriver"
            parameterType="java.lang.Integer">

        SELECT
        car_sn,
        driver_sn
        FROM
        tl_erp_driver
        <if test="id != null">
            WHERE user_id != #{id}
        </if>

    </select>
    <!-- SELECT u.*, dr.*, r.*, d.*, u.user_name AS user_name, u.user_phone
        AS user_phone, dr.user_id, dr.car_sn AS car_sn, dr.`car_cate` AS car_cate,
        r.car_owner, r.car_contact_phone, r.id, r.car_weight, r.car_length, r.car_load,
        d.card_rfid, s.gps_sn, s.gps_imei FROM tl_erp_driver dr LEFT JOIN tl_erp_car
        r ON r.`driver_id` = dr.id LEFT JOIN tl_erp_card d ON d.`driver_id` = dr.id
        LEFT JOIN tl_erp_gps s ON s.driver_id = dr.id INNER JOIN tl_erp_user u ON
        dr.`user_id` = u.`id` GROUP BY dr.id -->
    <!--车辆列表 供应商预约送货（录入车牌号）没有显示供应商司机 -->
    <!-- 20190305 debug 84 GSP 保存出错，数据库数据错误，要一条返回多条 -->
    <!-- 20190307 debug 68 只查客户车辆，加传参，不行就换控制类方法， -->
    <!-- if role_id=1{if test where car_cate=3} ,司机：园区供应商客户：123 -->
    <!--20190330 SELECT r.id,dr.user_id,
        dr.car_sn AS
        car_sn,car_owner,car_contact_phone,u.user_name AS
        user_name,u.user_phone AS
        user_phone,d.card_rfid,car_weight,car_length,car_load,s.gps_sn,s.gps_imei,dr.`car_cate`
        AS car_cate,
        u.user_company_name as user_company_name
        FROM tl_erp_driver dr
        LEFT JOIN tl_erp_car r ON
        r.`driver_id`=dr.id
        LEFT JOIN tl_erp_card d ON d.`driver_id` = dr.id
        LEFT JOIN tl_erp_gps s ON s.driver_id = dr.id
        INNER JOIN tl_erp_user u
        ON dr.`user_id`=u.`id`
        where 1=1
        <if test="car_cate != null">
            and dr.`car_cate` = #{car_cate},
        </if>
        <if test="search!=null and search!=''">
            and
        </if>
        GROUP BY dr.id-->
    <select id="lists_car" resultType="com.xiaoyuan.model.ErpDriver">
        SELECT
        u.real_name,
        u.number,
        dr.driver_sn,
        u.user_wechat AS user_wechar,
        r.id,
        dr.user_id,
        dr.car_sn AS car_sn,
        r.car_owner AS car_owner,
        r.car_contact_phone AS car_contact_phone,
        u.user_name AS user_name,
        u.user_phone AS user_phone,
        d.card_rfid,
        r.car_weight AS car_weight,
        r.car_length AS car_length,
        r.car_load AS car_load,
        s.device_id as gps_sn,
        s.imei_sn as gps_imei,
        dr.`car_cate` AS car_cate,
        u.user_company_name AS user_company_name,
        u.user_company_sn
        FROM
        tl_erp_driver dr
        LEFT JOIN tl_erp_car r ON r.`driver_id` = dr.id
        LEFT JOIN tl_erp_card d ON d.`driver_id` = dr.id
        LEFT JOIN tl_erp_gps_device s ON s.driver_id = dr.id
        LEFT JOIN tl_erp_user u ON dr.`user_id` = u.`id`
        WHERE
        1 =1
        <if test="car_cate != null">
            AND dr.`car_cate` = #{car_cate}
        </if>
        <if test="audit != null">
            AND u.audit = #{audit}
        </if>
        <if test="search!=null and search!=''">
            AND (
            u.user_name LIKE concat( concat( '%', #{search} ), '%' )
            OR u.number LIKE concat( concat( '%', #{search} ), '%' )
            OR u.user_company_name LIKE concat( concat( '%', #{search} ), '%' )
            OR dr.car_sn LIKE concat( concat( '%', #{search} ), '%' )
            OR u.real_name LIKE concat( concat( '%', #{search} ), '%' )
            OR u.user_phone LIKE concat( concat( '%', #{search} ), '%' )
            OR s.gps_sn LIKE concat( concat( '%', #{search} ), '%' )
            OR s.gps_imei LIKE concat( concat( '%', #{search} ), '%' )
            OR d.card_rfid LIKE concat( concat( '%', #{search} ), '%' )
            )
        </if>
        GROUP BY dr.id
    </select>

    <select id="driverConfirm" resultType="com.xiaoyuan.model.ErpDriver">
        SELECT
        o.`order_sn` AS order_sn,
        dr.`car_sn` as car_sn,
        u.user_name AS
        user_name,
        po.`grossweight` AS grossweight,
        u.`user_phone` AS
        user_phone,
        o.id
        FROM
        tl_erp_driver dr,
        tl_erp_pickgoods p,
        tl_erp_car c,
        tl_erp_card d,
        tl_erp_car_order r,
        tl_erp_user u,
        tl_erp_orders o,
        tl_erp_pound po
        WHERE dr.id = d.driver_id
        AND dr.id = c.driver_id
        AND
        dr.`car_sn` = p.`pickgoods_car_sn`
        AND u.id = dr.user_id
        AND
        o.`car_order_sn` = r.`car_order_sn`
        AND p.car_order_sn =
        r.`car_order_sn`
        AND o.id = po.`pickgoods_id`
        AND o.`status` = 1
        <if test="user_id != null">
            AND u.id = #{user_id}
        </if>
        <if test="car_sn != null and car_sn != ''">
            AND d.car_sn = #{car_sn}
        </if>
        GROUP BY dr.car_sn
    </select>


    <select id="driverChoosesn" resultType="com.xiaoyuan.model.ErpDriver">
        SELECT
        o.id as o_id
        FROM
        tl_erp_driver dr,
        tl_erp_pickgoods p,
        tl_erp_car
        c,
        tl_erp_card d,
        tl_erp_car_order r,
        tl_erp_user u,
        tl_erp_orders o
        WHERE
        dr.id = d.driver_id
        AND dr.id = c.driver_id
        AND dr.`car_sn` =
        p.`pickgoods_car_sn`
        AND u.id = dr.user_id
        AND o.`car_order_sn` =
        r.`car_order_sn`
        AND p.car_order_sn = r.`car_order_sn`
        AND o.`status` =
        1
        <if test="user_id != null">
            AND u.id = #{user_id}
        </if>
        <if test="car_sn != null and car_sn != ''">
            AND dr.car_sn = #{car_sn}
        </if>

    </select>

    <select id="getCarsnByRfid" resultType="com.xiaoyuan.model.ErpDriver">
		SELECT dr.car_sn FROM
		tl_erp_driver dr
		inner JOIN tl_erp_card c ON dr.id = c.driver_id
		where
		c.card_rfid =
		#{car_sn}
	</select>

    <delete id="deleteByUserId">
		delete from tl_erp_driver where user_id =#{user_id}
	</delete>

    <select id="getQueueByRfid" resultType="com.xiaoyuan.model.ErpDriver">
    SELECT
    tl_erp_driver.car_sn,
    tl_erp_pickgoods.car_order_sn
    FROM
    tl_erp_pickgoods
    LEFT JOIN tl_erp_driver ON tl_erp_pickgoods.pickgoods_car_sn = tl_erp_driver.car_sn
    LEFT JOIN tl_erp_card ON tl_erp_driver.id = tl_erp_card.driver_id
    WHERE
    tl_erp_card.card_rfid = #{car_sn}
    AND tl_erp_pickgoods.confirm_queue_datetime > now() - 60
    </select>

    <select id="selectBySearch" resultType="com.xiaoyuan.model.dto.ErpDriverDto">
        SELECT
        DRIVER.id AS driverId,
        DRIVER.user_id AS userId,
        DRIVER.car_sn AS carSn,
        CAR.car_load AS carLoad,
        USERS.user_phone AS userPhone,
        USERS.real_name AS realName,
        USERS.user_company_name

        FROM tl_erp_driver AS DRIVER
        LEFT JOIN tl_erp_car AS CAR ON CAR.driver_id = DRIVER.id
        LEFT JOIN tl_erp_user AS USERS ON USERS.id = DRIVER.user_id
        WHERE 1 = 1 and USERS.audit = 1
        <if test="null != userId and userId>0">
            AND DRIVER.user_id = #{userId}
        </if>
        <if test="null != driverId and driverId>0">
            AND DRIVER.id = #{driverId}
        </if>
        <if test="null != search and search !=''">
            AND (
            USERS.real_name LIKE CONCAT('%',#{search,jdbcType=VARCHAR},'%')
            OR DRIVER.car_sn LIKE CONCAT('%',#{search,jdbcType=VARCHAR},'%')
            )
        </if>
        <if test="cateId != null">
            AND DRIVER.cate_id = #{cateId}
        </if>
        <if test="isStop">
            AND USERS.stop is null
        </if>
        order by USERS.createtime DESC
    </select>
    <select id="countBySearch" resultType="java.lang.Integer">
        SELECT
        count(DRIVER.id)
        FROM tl_erp_driver AS DRIVER
        LEFT JOIN tl_erp_car AS CAR ON CAR.driver_id = DRIVER.id
        LEFT JOIN tl_erp_user AS USERS ON USERS.id = DRIVER.user_id
        WHERE 1 = 1 and USERS.audit = 1
        <if test="null != userId and userId>0">
            AND DRIVER.user_id = #{userId}
        </if>
        <if test="null != driverId and driverId>0">
            AND DRIVER.id = #{driverId}
        </if>
        <if test="null != search and search !=''">
            AND (
            USERS.real_name LIKE CONCAT('%',#{search,jdbcType=VARCHAR},'%')
            OR DRIVER.car_sn LIKE CONCAT('%',#{search,jdbcType=VARCHAR},'%')
            )
        </if>
        <if test="cateId != null">
            AND DRIVER.cate_id = #{cateId}
        </if>
        <if test="isStop">
            AND USERS.stop is null
        </if>
    </select>
    <select id="removeDriver" resultType="java.lang.Integer">
        update tl_erp_driver set car_sn =null ,driver_sn = null,goods_id = null,goods_name= null ,cate_id = null ,is_inside = null
        where id = #{id}
    </select>


</mapper>