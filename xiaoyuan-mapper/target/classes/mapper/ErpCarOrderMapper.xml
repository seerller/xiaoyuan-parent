<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.xiaoyuan.mapper.ErpCarOrderMapper">
    <!--WHERE p.is_return_goods is null 20190404-->
    <select id="lists" resultType="com.xiaoyuan.model.ErpCarOrder">
        SELECT
        r.id,
        dr.car_sn AS car_sn,
        dr.car_cate AS car_cate,
        p.car_order_sn AS car_order_sn,
        r.`car_order_pickdate`,
        r.`car_order_num`,
        r.`car_order_pick_num`,
        r.`car_order_remain_num`,
        car_order_address,
        c.`car_load` AS car_load,
        p.pickgoods_num AS pickgoods_num,
        u.user_company_name AS user_company_name,
        p.`id`,
        r.queue_sn,
        p.province_txt,
        p.city_txt,
        p.area_txt
        FROM
        tl_erp_driver dr
        LEFT JOIN tl_erp_pickgoods p ON p.`pickgoods_car_sn` = dr.`car_sn`
        LEFT JOIN tl_erp_user u ON u.`id` = p.`user_id`
        LEFT JOIN tl_erp_car_order r ON r.`car_order_sn` = p.car_order_sn
        LEFT JOIN tl_erp_car c ON c.driver_id = dr.id
        WHERE
        1 =1
        <if test="id != null">
            and dr.user_id = #{id}
        </if>
        <if test="car_order_sn != null">
            and p.car_order_sn = #{car_order_sn}
        </if>
    </select>

    <select id="lists_order" resultType="com.xiaoyuan.model.ErpCarOrder">
        (SELECT
        d.car_sn,
        p.createtime,
        p.pickgoods_num,
        r.id, p.car_order_sn,u.`user_company_name` AS
        pickgoods_send_company,p.user_address as
        car_order_address,p.`pickgoods_date` AS
        pickgoods_date,r.`car_order_pickdate`,car_order_id,
        r.pickgoods_id as pickgoods_id,
        p.is_car_order as is_car_order,
        p.is_confirm_queue as is_confirm_queue,
        p.confirm_queue_datetime as confirm_queue_datetime,
        p.province_txt,p.city_txt,p.area_txt
        FROM tl_erp_driver d
        INNER JOIN tl_erp_pickgoods p ON d.car_sn =
        p.pickgoods_car_sn
        INNER JOIN tl_erp_user u ON p.user_id = u.id
        LEFT
        JOIN tl_erp_car_order r ON p.car_order_sn = r.car_order_sn
        WHERE 1=1
        AND p.status_ = 1
        and order_cate='销售'
        <if test="car_order_pickdate != null and car_order_pickdate != ''">
            and r.car_order_pickdate is not null
        </if>
        <if test="user_id!=null">
            and d.user_id = #{user_id}
        </if>
        <if test="is_car_order != null">
            AND p.is_car_order = #{is_car_order}
        </if>
        GROUP BY r.car_order_sn
        order by r.createtime
        desc)

        union all

        (SELECT
        d.car_sn,
        p.createtime,
        p.pickgoods_num,
        r.id, p.car_order_sn,pickgoods_send_company,p.user_address AS
        car_order_address,p.`pickgoods_date` AS
        pickgoods_date,r.`car_order_pickdate`,car_order_id,
        r.pickgoods_id as pickgoods_id,
        p.is_car_order as is_car_order,
        p.is_confirm_queue as is_confirm_queue,
        p.confirm_queue_datetime as confirm_queue_datetime,
        p.province_txt,p.city_txt,p.area_txt
        FROM tl_erp_user u
        INNER JOIN tl_erp_driver d ON d.user_id = u.id
        INNER JOIN
        tl_erp_pickgoods p ON d.car_sn = p.pickgoods_car_sn
        LEFT JOIN
        tl_erp_car_order r ON p.car_order_sn = r.car_order_sn
        LEFT JOIN
        tl_erp_supplier s ON s.id = p.`supplier_id`
        WHERE 1=1
        AND p.status_ = 1
        AND
        order_cate='采购'
        <if test="car_order_pickdate != null and car_order_pickdate != ''">
            and r.car_order_pickdate is not null
        </if>
        <if test="user_id!=null">
            and d.user_id = #{user_id}
        </if>
        <if test="is_car_order != null">
            AND p.is_car_order = #{is_car_order}
        </if>
        GROUP BY r.car_order_sn
        order by r.createtime
        desc)
    </select>

    <select id="lists_order_ingoods" resultType="com.xiaoyuan.model.ErpCarOrder">
        SELECT r.id, r.car_order_sn,a.`user_company_name` AS
        pickgoods_send_company,a.`company_address` AS
        car_order_address,r.`car_order_pickdate`,car_order_id,i.createtime
        FROM tl_erp_driver d
        INNER JOIN tl_erp_user u ON d.`user_id` = u.id
        INNER JOIN tl_erp_ingoods i ON d.car_sn = i.ingoods_car_sn
        INNER JOIN
        tl_erp_user a ON a.id IN (SELECT b.`user_id` FROM tl_erp_supplier
        b,tl_erp_user a WHERE a.id=b.`user_id`)
        INNER JOIN tl_erp_car_order r
        ON i.ingoods_sn = r.car_order_sn
        WHERE 1=1
        AND i.status_=1
        <if test="car_order_pickdate != null and car_order_pickdate != ''">
            and r.car_order_pickdate is not null
        </if>
        and d.user_id = #{user_id}
        GROUP BY i.`ingoods_sn`
        order by r.createtime
        desc
    </select>

    <update id="updateCarOrder">
        update tl_erp_car_order
        <set>
            <if test="car_order_address != null and car_order_address != ''">
                car_order_address = #{car_order_address},
            </if>
            <if test="queue_sn != null ">
                queue_sn = #{queue_sn},
            </if>
            <if test="time != null and time != ''">
                timer=#{time},
            </if>
        </set>
        where car_order_sn = #{car_order_sn}
    </update>

    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
		insert into
		tl_erp_car_order(id,gps_id,driver_id,car_order_sn,car_order_pickdate,car_order_num,car_order_pick_num,car_order_remain_num,createtime,updatetime,status_,car_order_nowstate,car_order_thenstate,in_time,out_time,car_order_address,car_order_senddate,
		car_order_date,car_order_remark,car_order_money,car_order_price,car_order_id,pickgoods_id,accept_order)

		values
		(#{id},#{gps_id},#{driver_id},#{car_order_sn},#{car_order_pickdate},#{car_order_num},#{car_order_pick_num},#{car_order_remain_num},#{createtime},#{updatetime},#{status_},#{car_order_nowstate},#{car_order_thenstate},#{in_time},#{out_time},#{car_order_address},#{car_order_senddate},
		#{car_order_date},#{car_order_remark},#{car_order_price},#{car_order_money},#{car_order_id},#{pickgoods_id},#{accept_order})
	</insert>



    <select id="selectByPickgoodsId" resultType="com.xiaoyuan.model.ErpCarOrder">
        select *
        from tl_erp_car_order
        where pickgoods_id=#{pickgoods_id}
    </select>

    <select id="get" resultType="com.xiaoyuan.model.ErpCarOrder">
		select
		car_order_sn,car_order_pickdate,car_order_num,car_order_pick_num,car_order_remain_num,car_order_address,car_order_nowstate,car_order_thenstate,in_time,out_time,car_order_money,car_order_date,car_order_senddate,car_order_id,car_order_remark,car_order_price,pickgoods_id
		from tl_erp_car_order where id = #{id}
	</select>
    <select id="queueList" resultType="com.xiaoyuan.model.ErpCarOrder">
		SELECT
		dr.`car_sn`,c.`queue_sn` FROM tl_erp_car_order c
		INNER JOIN
		tl_erp_pickgoods p ON c.`car_order_sn` = p.car_order_sn
		INNER JOIN
		tl_erp_driver dr ON dr.`car_sn` = p.`pickgoods_car_sn`
		INNER JOIN
		tl_erp_user u ON dr.`user_id` = u.id
		where 1=1
		and queue_sn is not null
	</select>

    <select id="getCarOrder" resultType="com.xiaoyuan.model.ErpCarOrder">
        SELECT
        id,
        car_order_sn,
        car_order_pickdate,
        car_order_num,
        car_order_pick_num,
        car_order_remain_num,
        car_order_address,
        car_order_nowstate,
        car_order_thenstate,
        in_time,
        out_time,
        car_order_money,
        car_order_date,
        car_order_senddate,
        car_order_id,
        car_order_remark,
        car_order_price,
        pickgoods_id,
        queue_sn
        FROM
        tl_erp_car_order
        WHERE
        1=1
        <if test="car_order_sn!=null and car_order_sn!=''">
            and car_order_sn = #{car_order_sn}
        </if>
        <if test="pickgoods_id!=null">
            and pickgoods_id=#{pickgoods_id}
        </if>
    </select>

    <select id="getMaxQueue_sn" resultType="java.lang.Integer">
		select max(queue_sn) from
		tl_erp_car_order
	</select>

    <insert id="insertBatch">
        insert into tl_erp_car_order
        <foreach collection="list" item="item" index="index" >
            <if test="index ==0">
                <trim prefix="(" suffix=")" suffixOverrides=",">
                    <if test="item.id != null">
                        id,
                    </if>
                    <if test="item.gps_id != null">
                        gps_id,
                    </if>
                    <if test="item.driver_id != null">
                        driver_id,
                    </if>
                    <if test="item.car_order_sn != null">
                        car_order_sn,
                    </if>
                    <if test="item.car_order_pickdate != null">
                        car_order_pickdate,
                    </if>
                    <if test="item.car_order_num != null">
                        car_order_num,
                    </if>
                    <if test="item.car_order_pick_num != null">
                        car_order_pick_num,
                    </if>
                    <if test="item.car_order_remain_num != null">
                        car_order_remain_num,
                    </if>
                    <if test="item.createtime != null">
                        createtime,
                    </if>
                    <if test="item.updatetime != null">
                        updatetime,
                    </if>
                    <if test="item.status_ != null">
                        status_,
                    </if>
                    <if test="item.car_order_nowstate != null">
                        car_order_nowstate,
                    </if>
                    <if test="item.car_order_thenstate != null">
                        car_order_thenstate,
                    </if>
                    <if test="item.in_time != null">
                        in_time,
                    </if>
                    <if test="item.out_time != null">
                        out_time,
                    </if>
                    <if test="item.car_order_address != null">
                        car_order_address,
                    </if>
                    <if test="item.car_order_senddate != null">
                        car_order_senddate,
                    </if>
                    <if test="item.car_order_date != null">
                        car_order_date,
                    </if>
                    <if test="item.car_order_remark != null">
                        car_order_remark,
                    </if>
                    <if test="item.car_order_money != null">
                        car_order_money,
                    </if>
                    <if test="item.car_order_price != null">
                        car_order_price,
                    </if>
                    <if test="item.car_order_id != null">
                        car_order_id,
                    </if>
                    <if test="item.pickgoods_id != null">
                        pickgoods_id,
                    </if>
                    <if test="item.accept_order != null">
                        accept_order,
                    </if>
                </trim>
            </if>
        </foreach>
        <foreach collection="list" item="item" separator="," open="values">
            <trim prefix="(" suffix=")" suffixOverrides=",">
                <if test="item.id != null">
                    #{item.id,jdbcType=INTEGER},
                </if>
                <if test="item.gps_id != null">
                    #{item.gps_id,jdbcType=INTEGER},
                </if>
                <if test="item.driver_id != null">
                    #{item.driver_id,jdbcType=INTEGER},
                </if>
                <if test="item.car_order_sn != null">
                    #{item.car_order_sn},
                </if>
                <if test="item.car_order_pickdate != null">
                    #{item.car_order_pickdate},
                </if>
                <if test="item.car_order_num != null">
                    #{item.car_order_num},
                </if>
                <if test="item.car_order_pick_num != null">
                    #{item.car_order_pick_num},
                </if>
                <if test="item.car_order_remain_num != null">
                    #{item.car_order_remain_num},
                </if>
                <if test="item.createtime != null">
                    #{item.createtime},
                </if>
                <if test="item.updatetime != null">
                    #{item.updatetime},
                </if>
                <if test="item.status_ != null">
                    #{item.status_},
                </if>
                <if test="item.car_order_nowstate != null">
                    #{item.car_order_nowstate},
                </if>
                <if test="item.car_order_thenstate != null">
                    #{item.car_order_thenstate},
                </if>
                <if test="item.in_time != null">
                    #{item.in_time},
                </if>
                <if test="item.out_time != null">
                    #{item.out_time},
                </if>
                <if test="item.car_order_address != null">
                    #{item.car_order_address},
                </if>
                <if test="item.car_order_senddate != null">
                    #{item.car_order_senddate},
                </if>
                <if test="item.car_order_date != null">
                    #{item.car_order_date},
                </if>
                <if test="item.car_order_remark != null">
                    #{item.car_order_remark},
                </if>
                <if test="item.car_order_price != null">
                    #{item.car_order_price},
                </if>
                <if test="item.car_order_money != null">
                    #{item.car_order_money},
                </if>
                <if test="item.car_order_id != null">
                    #{item.car_order_id},
                </if>
                <if test="item.pickgoods_id != null">
                    #{item.pickgoods_id},
                </if>
                <if test="item.accept_order != null">
                    #{item.accept_order},
                </if>
            </trim>
        </foreach>
    </insert>
</mapper>