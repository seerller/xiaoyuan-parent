<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.xiaoyuan.mapper.ErpUserMapper">
    <!-- useGeneratedKeys="true" keyProperty="user_id" -->
    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
		insert
		into tl_erp_user
		(province_txt,city_txt,area_txt,id,user_name,password_,user_phone,user_company_name,user_cate,province_id,city_id,area_id,street_id,user_address,sales_area,user_description,rebate_balance,user_price,createtime,updatetime,status_,stop,role_id,token,audit,user_company_sn,user_telephone,user_wechat,user_contact,company_address,company_contact,company_cate)
		values
		(#{province_txt},#{city_txt},#{area_txt},#{id},#{user_name},#{password_},#{user_phone},#{user_company_name},#{user_cate},#{province_id},#{city_id},#{area_id},#{street_id},#{user_address},#{sales_area},#{user_description},#{rebate_balance},#{user_price},#{createtime},#{updatetime},#{status_},#{stop},#{role_id},#{token},#{audit},#{user_company_sn},#{user_telephone},#{user_wechat},#{user_contact},#{company_address},#{company_contact},#{company_cate})
	</insert>
    <insert id="insertService" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO tl_erp_user
        <trim prefix="(" suffixOverrides="," suffix=")">
            <if test="user_name != null ">
                user_name,
            </if>
            <if test="password_ != null  ">
                password_,
            </if>
            <if test="user_phone != null ">
                user_phone,
            </if>
            <if test="user_company_name != null ">
                user_company_name,
            </if>
            <if test="user_cate != null ">
                user_cate,
            </if>
            <if test="province_id != null ">
                province_id,
            </if>
            <if test="city_id != null ">
                city_id,
            </if>
            <if test="area_id != null ">
                area_id,
            </if>
            <if test="street_id != null ">
                street_id,
            </if>
            <if test="user_address != null ">
                user_address,
            </if>
            <if test="sales_area != null ">
                sales_area,
            </if>
            <if test="user_description != null ">
                user_description,
            </if>
            <if test="rebate_balance != null ">
                rebate_balance,
            </if>
            <if test="user_price != null">
                user_price,
            </if>
            <if test="createtime != null">
                createtime,
            </if>
            <if test="updatetime != null">
                updatetime,
            </if>
            <if test="status_ != null">
                status_,
            </if>
            <if test="user_company_sn != null">
                user_company_sn,
            </if>
            <if test="user_telephone != null">
                user_telephone,
            </if>
            <if test="user_wechat != null">
                user_wechat,
            </if>
            <if test="user_contact != null">
                user_contact,
            </if>
            <if test="company_contact != null">
                company_contact,
            </if>
            <if test="company_cate != null">
                company_cate,
            </if>
            <if test="company_address != null">
                company_address,
            </if>
            <if test="stop != null">
                stop,
            </if>
            <if test="role_id != null">
                role_id,
            </if>
            <if test="token != null">
                token,
            </if>
            <if test="audit != null">
                audit,
            </if>
            <if test="user_role_id != null">
                user_role_id,
            </if>
            <if test="department != null">
                department,
            </if>
            <if test="job != null">
                job,
            </if>
            <if test="real_name != null">
                real_name,
            </if>
            <if test="number != null">
                number,
            </if>
            <if test="province_txt != null">
                province_txt,
            </if>
            <if test="city_txt != null">
                city_txt,
            </if>
            <if test="limit_max != null">
                limit_max,
            </if>
            <if test="min_number != null">
                min_number,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="user_name != null ">
               #{user_name},
            </if>
            <if test="password_ != null  ">
                #{password_},
            </if>
            <if test="user_phone != null ">
                #{user_phone},
            </if>
            <if test="user_company_name != null ">
                #{user_company_name},
            </if>
            <if test="user_cate != null ">
               #{user_cate},
            </if>
            <if test="province_id != null ">
                #{province_id},
            </if>
            <if test="city_id != null ">
                #{city_id},
            </if>
            <if test="area_id != null ">
                #{area_id},
            </if>
            <if test="street_id != null ">
                #{street_id},
            </if>
            <if test="user_address != null ">
                #{user_address},
            </if>
            <if test="sales_area != null ">
                #{sales_area},
            </if>
            <if test="user_description != null ">
                #{user_description},
            </if>
            <if test="rebate_balance != null ">
               #{rebate_balance},
            </if>
            <if test="user_price != null">
                #{user_price},
            </if>
            <if test="createtime != null">
                #{createtime},
            </if>
            <if test="updatetime != null">
                #{updatetime},
            </if>
            <if test="status_ != null">
                #{status_},
            </if>
            <if test="user_company_sn != null">
                #{user_company_sn},
            </if>
            <if test="user_telephone != null">
               #{user_telephone},
            </if>
            <if test="user_wechat != null">
                #{user_wechat},
            </if>
            <if test="user_contact != null">
               #{user_contact},
            </if>
            <if test="company_contact != null">
               #{company_contact},
            </if>
            <if test="company_cate != null">
                #{company_cate},
            </if>
            <if test="company_address != null">
                #{company_address},
            </if>
            <if test="stop != null">
                #{stop},
            </if>
            <if test="role_id != null">
                #{role_id},
            </if>
            <if test="token != null">
                #{token},
            </if>
            <if test="audit != null">
                #{audit},
            </if>
            <if test="user_role_id != null">
               #{user_role_id},
            </if>
            <if test="department != null">
                #{department},
            </if>
            <if test="job != null">
                #{job},
            </if>
            <if test="real_name != null">
                #{real_name},
            </if>
            <if test="number != null">
                #{number},
            </if>
            <if test="province_txt != null">
                #{province_txt},
            </if>
            <if test="city_txt != null">
                #{city_txt},
            </if>
            <if test="limit_max != null">
                #{limit_max},
            </if>
            <if test="min_number != null">
                #{min_number},
            </if>
        </trim>
    </insert>
    <delete id="delete_user">
		delete from tl_erp_user where id=#{id}
	</delete>
    <delete id="delete_driver">
		delete from tl_erp_driver where user_id=#{id}
	</delete>
    <sql id="BaseCounml">

    </sql>
    <select id="lists" resultType="com.xiaoyuan.model.ErpUser">
        SELECT
        u.id AS id,
        u.createtime,
        u.*,
        r.*,
        d.*,
        c.*,
        role.*
        FROM
        tl_erp_user u
        LEFT JOIN tl_erp_supplier r ON u.id = r.`user_id`
        LEFT JOIN tl_erp_driver d ON u.id = d.`user_id`
        LEFT JOIN tl_erp_car c ON d.id = c.driver_id
        LEFT JOIN tl_user_child_role role ON u.role_id = role.role_id
        WHERE
        1=1
        <if test="user_cate!=null">
            /*用户分类判断*/
            and u.user_cate =#{user_cate}
        </if>

        <if test="role_id==1">
            and u.role_id =#{role_id}
        </if>
        <if test="role_id==2">
            and u.role_id =#{role_id}
        </if>
        <if test="role_id==4">
            and u.role_id =#{role_id}
        </if>
        <if test="role_id==3">
            and u.role_id not in (1,2,4)
        </if>
        <if test="audit!=null">
            and u.audit =#{audit}
        </if>
        <if test="s_id!=null">
            and u.supplier_id =#{s_id}
        </if>
        <if test="search!=null and search!=''">
            AND (
            u.user_name LIKE concat( concat( '%', #{search} ), '%' )
            OR u.user_company_sn LIKE concat( concat( '%', #{search} ), '%' )
            OR u.real_name LIKE concat( concat( '%', #{search} ), '%' )
            OR u.user_phone LIKE concat( concat( '%', #{search} ), '%' )
            OR u.user_wechat LIKE concat( concat( '%', #{search} ), '%' )
            OR u.department LIKE concat( concat( '%', #{search} ), '%' )
            OR u.job LIKE concat( concat( '%', #{search} ), '%' )
            OR u.user_company_name LIKE concat( concat( '%', #{search} ), '%' )
            OR u.user_contact LIKE concat( concat( '%', #{search} ), '%' )
            OR u.company_contact LIKE concat( concat( '%', #{search} ), '%' )
            OR u.user_telephone LIKE concat( concat( '%', #{search} ), '%' )
            OR u.user_address LIKE concat( concat( '%', #{search} ), '%' )
            OR u.company_address LIKE concat( concat( '%', #{search} ), '%' )
            )
        </if>
        ORDER BY
        u.createtime
    </select>
    <delete id="delete_supplier">
		delete from tl_erp_supplier where user_id=#{id}
	</delete>

    <select id="login" resultType="com.xiaoyuan.model.ErpUser">
		select * from tl_erp_user where stop is null and
		user_name=#{login_name}
	</select>

    <select id="existsPhone" resultType="com.xiaoyuan.model.ErpUser">
        select * from tl_erp_user
        where user_phone=#{user_phone}
        <if test="id!=null">
            and id!=#{id}
        </if>
    </select>


    <update id="forgetPassword">
        update tl_erp_user
        <set>
            <if test="password_ != null and password_ != '' ">
                password_=#{password_},
            </if>
            <if test="token != null and token != '' ">
                token=#{token}
            </if>
        </set>
        where user_name=#{user_name}
    </update>

    <select id="increment" resultType="int">
		select max(id) from
		tl_erp_user
	</select>

    <select id="lists_user_cate" resultType="com.xiaoyuan.model.ErpUser">
		SELECT
		u.id,u.user_name,u.user_cate,r.role_name AS
		role_name,u.createtime,user_phone FROM tl_erp_user u,tl_erp_role r
		WHERE u.role_id=r.id
	</select>

    <select id="getUserIdByToken" resultType="java.lang.Integer">
		select id from
		tl_erp_user where token = #{token}
	</select>

    <select id="balance" resultType="com.xiaoyuan.model.ErpUser">
		select rebate_balance from
		tl_erp_user where id =#{id}
	</select>

    <select id="selectByUserId" resultType="com.xiaoyuan.model.ErpUser">
        select * from
		tl_erp_user where id =#{id}
    </select>

    <!-- 获取同一个账户在所有表中的信息 -->
    <!-- 司机审核发现失败，原来是根据ID更新的操作没有ID，加上查内容ID -->

    <!-- 20190302 加上终端客户列 -->
    <!-- 20190305 去掉终端客户列，否则有返回多条记录SQL报错，终端客户用别的方法实现吧。。 -->
    <select id="get" resultType="com.xiaoyuan.model.ErpUser">
		SELECT
		u.*,
		r.id AS s_id,
		r.goods_name AS goods_name,
		d.`driver_sn` AS driver_sn,
		d.`car_sn` AS car_sn,
		d.`driver_use_date` AS driver_use_date,
		d.`driver_eff_date` AS driver_eff_date
		FROM
		tl_erp_user u
		LEFT JOIN tl_erp_supplier r ON u.id = r.`user_id`
		LEFT JOIN tl_erp_driver d ON u.id = d.`user_id`
		WHERE u.id = #{id}
	</select>

    <!-- YZH 20190304 debug 91 使用了非空全字段，可以，， -->
    <update id="update">
        update tl_erp_user
        <set>
            <if test="user_name !=null and user_name != ''">
                user_name=#{user_name},
            </if>
            <if test="password_!=null and password_ !=''">
                password_=#{password_},
            </if>
            <if test="user_phone !=null and user_phone != ''">
                user_phone=#{user_phone},
            </if>
            <if test="user_company_name !=null and user_company_name != ''">
                user_company_name=#{user_company_name},
            </if>
            <!-- 少了usercate,,,或者说改了,, -->
            <if test="user_address !=null and user_address != ''">
                user_address=#{user_address},
            </if>
            <if test="sales_area !=null and sales_area != ''">
                sales_area=#{sales_area},
            </if>
            <if test="user_description !=null and user_description != ''">
                user_description=#{user_description},
            </if>
            <if test="rebate_balance !=null">
                rebate_balance=#{rebate_balance},
            </if>
            <if test="user_price !=null ">
                user_price=#{user_price},
            </if>
            <if test="updatetime !=null and updatetime != ''">
                updatetime=#{updatetime},
            </if>
            <if test="status_ !=null ">
                status_=#{status_},
            </if>
            <if test="user_company_sn !=null and user_company_sn != ''">
                user_company_sn=#{user_company_sn},
            </if>
            <if test="user_telephone !=null and user_telephone != ''">
                user_telephone=#{user_telephone},
            </if>
            <if test="user_wechat !=null and user_wechat != ''">
                user_wechat=#{user_wechat},
            </if>
            <!-- 应该是先生成mapper，改了mapper之后，后又改的表，mapper没改 -->
            <if test="user_contact !=null and user_contact != ''">
                user_contact=#{user_contact},
            </if>
            <if test="company_contact !=null and company_contact != ''">
                company_contact=#{company_contact},
            </if>
            <if test="company_cate !=null and company_cate != ''">
                company_cate=#{company_cate},
            </if>
            <if test="company_address !=null and company_address != ''">
                company_address=#{company_address},
            </if>
            <if test="stop !=null">
                stop=#{stop},
            </if>
            <if test="role_id !=null ">
                role_id=#{role_id},
            </if>
            <if test="audit !=null">
                audit=#{audit},
            </if>
            <if test="department !=null and department!=''">
                department=#{department},
            </if>
            <if test="job !=null and job!=''">
                job=#{job},
            </if>
            <if test="real_name !=null and real_name!=''">
                real_name=#{real_name},
            </if>
            <if test="number !=null and number!=''">
                number=#{number},
            </if>
            <if test="province_txt !=null and province_txt!=''">
                province_txt=#{province_txt},
            </if>
            <if test="city_txt !=null and city_txt!=''">
                city_txt=#{city_txt},
            </if>
            <if test="area_txt !=null and area_txt!=''">
                area_txt=#{area_txt},
            </if>
            <if test="token !=null and token!=''">
                token=#{area_txt},
            </if>
        </set>
        where id = #{id}
    </update>


    <update id="audit">
        update tl_erp_user
        <set>
            <if test="audit != null and audit != '' ">
                audit=#{audit}
            </if>
        </set>
        where id=#{id}
        <!-- and user_phone=#{user_phone} -->
    </update>





    <update id="updateServiceByPrimaryKey">
        UPDATE tl_erp_user
        <set>
            <trim suffixOverrides=",">
                <if test="user_name != null ">
                    user_name=#{user_name},
                </if>
                <if test="password_ != null  ">
                    password_=#{password_},
                </if>
                <if test="user_phone != null ">
                    user_phone=#{user_phone},
                </if>
                <if test="user_company_name != null ">
                    user_company_name=#{user_company_name},
                </if>
                <if test="user_cate != null ">
                    user_cate=#{user_cate},
                </if>
                <if test="province_id != null ">
                    province_id=#{province_id},
                </if>
                <if test="city_id != null ">
                    city_id=#{city_id},
                </if>
                <if test="area_id != null ">
                    area_id=#{area_id},
                </if>
                <if test="street_id != null ">
                    street_id=#{street_id},
                </if>
                <if test="user_address != null ">
                    user_address=#{user_address},
                </if>
                <if test="sales_area != null ">
                    sales_area=#{sales_area},
                </if>
                <if test="user_description != null ">
                    user_description=#{user_description},
                </if>
                <if test="rebate_balance != null ">
                    rebate_balance=#{rebate_balance},
                </if>
                <if test="user_price != null">
                    user_price=#{user_price},
                </if>
                <if test="createtime != null">
                    createtime=#{createtime},
                </if>
                <if test="updatetime != null">
                    updatetime=#{updatetime},
                </if>
                <if test="status_ != null">
                    status_=#{status_},
                </if>
                <if test="user_company_sn != null">
                    user_company_sn=#{user_company_sn},
                </if>
                <if test="user_telephone != null">
                    user_telephone=#{user_telephone},
                </if>
                <if test="user_wechat != null">
                    user_wechat=#{user_wechat},
                </if>
                <if test="user_contact != null">
                    user_contact=#{user_contact},
                </if>
                <if test="company_contact != null">
                    company_contact=#{company_contact},
                </if>
                <if test="company_cate != null">
                    company_cate=#{company_cate},
                </if>
                <if test="company_address != null">
                    company_address=#{company_address},
                </if>
                <if test="stop != null">
                    stop=#{stop},
                </if>
                <if test="role_id != null">
                    role_id=#{role_id},
                </if>
                <if test="token != null">
                    token=#{token},
                </if>
                <if test="audit != null">
                    audit=#{audit},
                </if>
                <if test="user_role_id != null">
                    user_role_id=#{user_role_id},
                </if>
                <if test="department != null">
                    department=#{department},
                </if>
                <if test="job != null">
                    job=#{job},
                </if>
                <if test="real_name != null">
                    real_name=#{real_name},
                </if>
                <if test="number != null">
                    number=#{number},
                </if>
                <if test="province_txt != null">
                    province_txt=#{province_txt},
                </if>
                <if test="city_txt != null">
                    city_txt=#{city_txt},
                </if>
                <if test="limit_max != null">
                    limit_max=#{limit_max},
                </if>
                <if test="min_number != null">
                    min_number=#{min_number},
                </if>
            </trim>
        </set>
        where 1 = 1
        <if test="updateParams == 'id'">
          and id=#{id}
        </if>
    </update>
    <select id="uniqueNumber" resultType="java.lang.Integer">
        <if test="type">
            select count(users.id) from tl_erp_user as users
            where  users.number  = #{search}
            <if test="userId!= null">
                and users.id != #{userId}
            </if>
        </if>
        <if test="!type">
            select count(customer.id) from tl_erp_terminal_customer as customer
            where  customer.customer_sn  = #{search} and stop is null
            <if test="customerId!= null">
                and customer.id != #{customerId}
            </if>
        </if>
    </select>

    <select id="user_role_list" resultType="com.xiaoyuan.model.UserRole">
		SELECT t.*
		FROM
		tl_user_child_role t
	</select>

    <select id="selectBySearch" resultType="com.xiaoyuan.model.dto.ErpUserDto">
        SELECT
        USERS.id,USERS.role_id,USERS.user_name,USERS.real_name,USERS.user_phone,USERS.user_company_name,USERS.rebate_balance,USERS.number,
        USERS.user_address,USERS.sales_area,IFNULL(USERS.user_price,0.00) AS user_price,USERS.department,USERS.job,
        DRIVER.is_inside,DRIVER.driver_sn,DRIVER.car_sn,CAR.car_owner,CAR.car_contact_phone,CAR.car_weight,CAR.car_load,
        CARD.card_rfid,GPS.gps_imei,CARD.card_state, DATE_FORMAT( CARD.card_open_date, "%Y-%m-%d %H:%i:%s" ) as card_open_date,
        GPS.gps_sn,USERS.user_cate,IFNULL(USERS.limit_max,0.00) as limit_max,IFNULL(USERS.min_number,0.00) as min_number,
        DRIVER.id AS driverId,CAR.id as carId,GPS.id AS gpsId,CARD.id AS cardId,DRIVER.cate_id,
        CASE DRIVER.cate_id WHEN 1 THEN "销货车辆" WHEN 2 THEN "进货车辆" ELSE "未知类型" END AS carCate,
        CASE USERS.user_cate
        WHEN 1 THEN "客户"
        WHEN 2 THEN "供应商"
        WHEN 3 THEN "园区用户"
        WHEN 4 THEN "司机用户"
        ELSE "未知类型" END AS userCate,USERS.number as user_company_sn,
        FORMAT(USERS.rebate_balance,2) as rebateBalanceTxt,
        FORMAT(USERS.user_price,2) as userPirce,
        DRIVER.goods_name,DRIVER.goods_id,
        (CASE WHEN CARD.status_ IS NULL then 0 else CARD.status_ end) as cardStatus,
        USERS.province_id,USERS.city_id,USERS.area_id,
        REGIONS.provinceTxt AS province_txt,REGIONS.cityTxt AS city_txt,REGIONS.areaTxt AS area_txt ,
        CONCAT('[',REGIONS.provinceTxt,' ',REGIONS.cityTxt,' ',REGIONS.areaTxt,']') as str
        from tl_erp_user AS USERS
        LEFT JOIN tl_erp_driver AS DRIVER ON DRIVER.user_id = USERS.id
        LEFT JOIN tl_erp_car AS CAR ON CAR.user_id = USERS.id
        LEFT JOIN tl_erp_card AS CARD ON CARD.driver_id = DRIVER.id
        LEFT JOIN tl_erp_gps AS GPS ON GPS.driver_id = DRIVER.id
        LEFT JOIN (
        SELECT
        USERS.id AS id,
        MAX( CASE USERS.province_id WHEN REGION.id THEN REGION.title ELSE NULL END ) provinceTxt,
        MAX( CASE USERS.city_id WHEN REGION.id THEN REGION.title ELSE NULL END ) cityTxt,
        MAX( CASE USERS.area_id WHEN REGION.id THEN REGION.title ELSE NULL END ) areaTxt
        FROM
        tl_erp_user   AS USERS
        LEFT JOIN tl_erp_region AS REGION ON REGION.id = USERS.province_id
        OR REGION.id = USERS.city_id
        OR REGION.id = USERS.area_id
        GROUP BY
        USERS.id ) AS REGIONS ON REGIONS.id = USERS.Id
        WHERE 1=1
        <if test="null!=search and search != ''">
            AND (
            USERS.real_name LIKE concat( concat( '%', #{search} ), '%' )
            OR USERS.user_name LIKE concat( concat( '%', #{search} ), '%' )
            OR USERS.number LIKE concat( concat( '%', #{search} ), '%' )
            OR DRIVER.car_sn LIKE concat( concat( '%', #{search} ), '%' )
            OR USERS.user_phone LIKE concat( concat( '%', #{search} ), '%' )
            OR USERS.user_company_name LIKE concat( concat( '%', #{search} ), '%' )
            OR DRIVER.goods_name LIKE concat( concat( '%', #{search} ), '%' )
            OR USERS.user_address LIKE concat( concat( '%', #{search} ), '%' )
            OR GPS.gps_sn LIKE concat( concat( '%', #{search} ), '%' )
            OR GPS.gps_imei LIKE concat( concat( '%', #{search} ), '%' )
            OR CARD.card_rfid LIKE concat( concat( '%', #{search} ), '%' )
            )
        </if>
        <if test="null!=userCate and userCate > 0">
            AND USERS.user_cate = #{userCate}
        </if>
        <if test="null!=userId and userId >0">
            AND USERS.id &lt;&gt; #{userId}
        </if>
        <if test="null!=id and id >0">
            AND USERS.id = #{id}
        </if>
        <if test="null!=phone and phone != ''">
            AND USERS.user_phone = #{phone}
        </if>
        <if test="audit!=null">
            AND USERS.audit = #{audit}
        </if>
        <if test="cateId!=null">
            AND DRIVER.cate_id = #{cateId}
        </if>
        <if test="stop!=null">
            <if test="stop == 1">
                AND USERS.stop IS NULL
            </if>
        </if>
        <if test="reomveNotCard!=null">
            <if test="reomveNotCard == 1">
                AND CARD.id IS NOT NULL
            </if>
            <if test="reomveNotCard == -1">
                AND CARD.id IS NULL
            </if>
        </if>
        <if test="notIn!=null">
            AND USER.id not in
            <foreach close=")" collection="notIn" item="listItem" open="(" separator=",">
            #{listItem}
            </foreach>
        </if>
        <if test="groupBy!=null">
            <if test="columnName!=null and columnName!=''">
                GROUP BY #{columnName}
            </if>
            <if test="columnName==null or columnName==''">
                GROUP BY USERS.user_company_name
            </if>
        </if>
        order by USERS.createtime DESC
    </select>
    <select id="countBySearch" resultType="java.lang.Integer">
        SELECT
        count(USERS.id)
        from tl_erp_user AS USERS
        LEFT JOIN tl_erp_driver AS DRIVER ON DRIVER.user_id = USERS.id
        LEFT JOIN tl_erp_car AS CAR ON CAR.user_id = USERS.id
        LEFT JOIN tl_erp_card AS CARD ON CARD.driver_id = DRIVER.id
        LEFT JOIN tl_erp_gps AS GPS ON GPS.driver_id = DRIVER.id
        LEFT JOIN (
        SELECT
        USERS.id AS id,
        MAX( CASE USERS.province_id WHEN REGION.id THEN REGION.title ELSE NULL END ) provinceTxt,
        MAX( CASE USERS.city_id WHEN REGION.id THEN REGION.title ELSE NULL END ) cityTxt,
        MAX( CASE USERS.area_id WHEN REGION.id THEN REGION.title ELSE NULL END ) areaTxt
        FROM
        tl_erp_user   AS USERS
        LEFT JOIN tl_erp_region AS REGION ON REGION.id = USERS.province_id
        OR REGION.id = USERS.city_id
        OR REGION.id = USERS.area_id
        GROUP BY
        USERS.id ) AS REGIONS ON REGIONS.id = USERS.Id
        WHERE 1=1
        <if test="null!=search and search != ''">
            AND (
            USERS.real_name LIKE concat( concat( '%', #{search} ), '%' )
            OR USERS.user_name LIKE concat( concat( '%', #{search} ), '%' )
            OR USERS.number LIKE concat( concat( '%', #{search} ), '%' )
            OR DRIVER.car_sn LIKE concat( concat( '%', #{search} ), '%' )
            OR USERS.user_phone LIKE concat( concat( '%', #{search} ), '%' )
            OR USERS.user_company_name LIKE concat( concat( '%', #{search} ), '%' )
            OR DRIVER.goods_name LIKE concat( concat( '%', #{search} ), '%' )
            OR USERS.user_address LIKE concat( concat( '%', #{search} ), '%' )
            OR GPS.gps_sn LIKE concat( concat( '%', #{search} ), '%' )
            OR GPS.gps_imei LIKE concat( concat( '%', #{search} ), '%' )
            OR CARD.card_rfid LIKE concat( concat( '%', #{search} ), '%' )
            )
        </if>
        <if test="null!=userCate and userCate > 0">
            AND USERS.user_cate = #{userCate}
        </if>
        <if test="null!=userId and userId >0">
            AND USERS.id &lt;&gt; #{userId}
        </if>
        <if test="null!=id and id >0">
            AND USERS.id = #{id}
        </if>
        <if test="null!=phone and phone != ''">
            AND USERS.user_phone = #{phone}
        </if>
        <if test="audit!=null">
            AND USERS.audit = #{audit}
        </if>
        <if test="cateId!=null">
            AND DRIVER.cate_id = #{cateId}
        </if>
        <if test="stop!=null">
            <if test="stop == 1">
                AND USERS.stop IS NULL
            </if>
        </if>
        <if test="reomveNotCard!=null">
            <if test="reomveNotCard == 1">
                AND CARD.id IS NOT NULL
            </if>
            <if test="reomveNotCard == -1">
                AND CARD.id IS NULL
            </if>
        </if>
    </select>

    <select id="selectUserPnoneIsOnly" resultType="java.lang.Integer">
        SELECT COUNT(ID) FROM tl_erp_user where 1=1
         <if test="userId!=null">
             and id !=#{userId}
         </if>
         and user_phone = #{phone}
    </select>
    <select id="userNameUnique" resultType="java.lang.Integer">
        SELECT COUNT(ID) FROM tl_erp_user where 1 = 1 AND user_name = #{user_name}
    </select>
    <select id="resultUsersByUserIds" resultType="com.xiaoyuan.model.ErpUser">
        SELECT
            user_phone
        FROM tl_erp_user
        WHERE 1 = 1
        <if test="userIds!=null">
            AND id in
            <foreach close=")" collection="userIds" item="listItem" open="(" separator=",">
                #{listItem}
            </foreach>
        </if>
    </select>
</mapper>