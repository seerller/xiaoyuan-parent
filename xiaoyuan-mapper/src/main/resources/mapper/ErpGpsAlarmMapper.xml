<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.xiaoyuan.mapper.ErpGpsAlarmMapper">
    <delete id="deleteById">
        DELETE FROM tl_erp_gps_alarm WHERE id =#{id}
    </delete>
    <select id="selectBySearch" resultType="com.xiaoyuan.model.dto.ErpGpsAlarmDto">
        SELECT alarm.*, DATE_FORMAT( alarm.create_time, "%Y-%m-%d %H:%i:%s" ) as alarmTime,
        (CASE alarm.gps_alarm_cate
        when 0 THEN "超时未达"
        WHEN 1 THEN "卸货时间过短" ELSE "未知类型" END) AS gpsAlarmCateTxt,
        alarm.driver_real_name AS driverName,
        alarm.gps_phone AS driverPhone,
        alarm.customer_name AS customerName,
        alarm.car_sn AS carSn,
        alarm.order_sn AS orderSn,provinceTxt,cityTxt,areaTxt
        FROM tl_erp_gps_alarm AS alarm
        LEFT JOIN (
        SELECT
        CUSTOMER.id AS id,
        MAX( CASE CUSTOMER.province_id WHEN REGION.id THEN REGION.title ELSE NULL END ) provinceTxt,
        MAX( CASE CUSTOMER.city_id WHEN REGION.id THEN REGION.title ELSE NULL END ) cityTxt,
        MAX( CASE CUSTOMER.area_id WHEN REGION.id THEN REGION.title ELSE NULL END ) areaTxt
        FROM
        tl_erp_terminal_customer AS CUSTOMER
        LEFT JOIN tl_erp_region AS REGION ON REGION.id = CUSTOMER.province_id
        OR REGION.id = CUSTOMER.city_id
        OR REGION.id = CUSTOMER.area_id
        GROUP BY
        CUSTOMER.id ) AS REGIONS ON REGIONS.id = alarm.customer_id
        WHERE 1 = 1
        <if test="gpsId != null and gpsId >0">
            AND alarm.id = #{gpsId}
        </if>
        <if test="null != status and status >=0">
            AND alarm.status = #{status}
        </if>
        <if test="null != carSn and carSn != ''">
            AND alarm.car_sn = #{carSn}
        </if>
        <if test="startTime!=null and startTime!=''">
            and alarm.create_time &gt;=#{startTime}
        </if>
        <if test="endTime!=null and endTime!=''">
            and alarm.create_time &lt;=CONCAT(#{endTime}, ' 23:59:59')
        </if>
        <if test="nowTime!=null and nowTime!= ''">
            AND alarm.create_time between #{nowTime} and CONCAT(#{nowTime}, ' 23:59:59')
        </if>
        <if test="orderId!=null and orderId!= ''">
            AND alarm.order_id = #{orderId}
        </if>
        order by alarm.create_time DESC
    </select>
    <select id="countBySearch" resultType="java.lang.Integer">
        SELECT count(alarm.id)
        FROM tl_erp_gps_alarm AS alarm
        WHERE 1 = 1
        <if test="gpsId != null and gpsId >0">
            AND alarm.id = #{gpsId}
        </if>
        <if test="null != status and status >=0">
            AND alarm.status = #{status}
        </if>
        <if test="null != carSn and carSn != ''">
            AND alarm.car_sn = #{carSn}
        </if>
        <if test="startTime!=null and startTime!=''">
            and alarm.create_time &gt;=#{startTime}
        </if>
        <if test="endTime!=null and endTime!=''">
            and alarm.create_time &lt;=CONCAT(#{endTime}, ' 23:59:59')
        </if>
    </select>
    <insert id="insertService">
        INSERT INTO tl_erp_gps_alarm
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="id != null">
                id,
            </if>
            <if test="user_id != null">
                user_id,
            </if>
            <if test="gps_sn != null">
                gps_sn,
            </if>
            <if test="gps_imei != null">
                gps_imei,
            </if>
            <if test="create_time != null">
                create_time,
            </if>
            <if test="handling_time != null">
                handling_time,
            </if>
            <if test="gps_handling != null">
                gps_handling,
            </if>
            <if test="gps_phone != null">
                gps_phone,
            </if>
            <if test="gps_queue != null">
                gps_queue,
            </if>
            <if test="gps_alarm_cate != null">
                gps_alarm_cate,
            </if>
            <if test="order_id != null">
                order_id,
            </if>
            <if test="gps_send_goods != null">
                gps_send_goods,
            </if>
            <if test="car_sn != null">
                car_sn,
            </if>
            <if test="order_sn != null">
                order_sn,
            </if>
            <if test="customer_name != null">
                customer_name,
            </if>
            <if test="status != null">
                status,
            </if>
            <if test="send_address != null">
                send_address,
            </if>
            <if test="handling_man != null">
                handling_man,
            </if>
            <if test="driver_real_name != null">
                driver_real_name,
            </if>
            <if test="customer_id != null">
                customer_id,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="id != null">
                #{id},
            </if>
            <if test="user_id != null">
               #{user_id},
            </if>
            <if test="gps_sn != null">
              #{gps_sn},
            </if>
            <if test="gps_imei != null">
               #{gps_imei},
            </if>
            <if test="create_time != null">
               #{create_time},
            </if>
            <if test="handling_time != null">
               #{handling_time},
            </if>
            <if test="gps_handling != null">
               #{gps_handling},
            </if>
            <if test="gps_phone != null">
                 #{gps_phone},
            </if>
            <if test="gps_queue != null">
                #{gps_queue},
            </if>
            <if test="gps_alarm_cate != null">
                 #{gps_alarm_cate},
            </if>
            <if test="order_id != null">
                #{order_id},
            </if>
            <if test="gps_send_goods != null">
               #{gps_send_goods},
            </if>
            <if test="car_sn != null">
               #{car_sn},
            </if>
            <if test="order_sn != null">
               #{order_sn},
            </if>
            <if test="customer_name != null">
               #{customer_name},
            </if>
            <if test="status != null">
                #{status},
            </if>
            <if test="send_address != null">
                 #{send_address},
            </if>
            <if test="handling_man != null">
               #{handling_man},
            </if>
            <if test="driver_real_name != null">
                #{driver_real_name},
            </if>
            <if test="customer_id != null">
                #{customer_id},
            </if>
        </trim>
    </insert>


    <update id="updateService">
        update tl_erp_gps_alarm
        <set>
            <if test="user_id != null">
                user_id= #{user_id},
            </if>
            <if test="gps_sn != null">
                gps_sn= #{gps_sn},
            </if>
            <if test="gps_imei != null">
                gps_imei= #{gps_imei},
            </if>
            <if test="create_time != null">
                create_time= #{create_time},
            </if>
            <if test="handling_time != null">
                handling_time= #{handling_time},
            </if>
            <if test="gps_handling != null">
                gps_handling= #{gps_handling},
            </if>
            <if test="gps_phone != null">
                gps_phone= #{gps_phone},
            </if>
            <if test="gps_queue != null">
                gps_queue= #{gps_queue},
            </if>
            <if test="gps_alarm_cate != null">
                gps_alarm_cate= #{gps_alarm_cate},
            </if>
            <if test="order_id != null">
                order_id= #{order_id},
            </if>
            <if test="gps_send_goods != null">
                gps_send_goods= #{gps_send_goods},
            </if>
            <if test="car_sn != null">
                car_sn= #{car_sn},
            </if>
            <if test="order_sn != null">
                order_sn= #{order_sn},
            </if>
            <if test="customer_name != null">
                customer_name= #{customer_name},
            </if>
            <if test="status != null">
                status= #{status},
            </if>
            <if test="send_address != null">
                send_address= #{send_address},
            </if>
            <if test="handling_man != null">
                handling_man= #{handling_man},
            </if>
            <if test="driver_real_name != null">
                driver_real_name= #{driver_real_name},
            </if>
            <if test="customer_id != null">
                customer_id= #{customer_id},
            </if>
        </set>
        WHERE id = #{id}
    </update>

</mapper>